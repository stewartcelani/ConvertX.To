<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\dev\ConvertX.To\src\Infrastructure\ConvertX.To.Infrastructure.Shared\Services\MsGraphFileConversionService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Net.Http.Headers;
using System.Net.Http.Json;
using ConvertX.To.Application.Domain.Settings;
using ConvertX.To.Application.Exceptions;
using ConvertX.To.Application.Interfaces;
using ConvertX.To.Domain.External.MicrosoftGraph.Responses;
using Microsoft.Graph;
using MimeTypes.Core;

namespace ConvertX.To.Infrastructure.Shared.Services;

/// &lt;summary&gt;
///     Service using the Microsoft Graph (beta) Files -&gt; Drive Items -&gt; Convert file API
///     to request file contents in supported formats
///     https://docs.microsoft.com/en-us/graph/api/driveitem-get-content-format?view=graph-rest-beta&amp;tabs=http
///     HTTP GET /drive/items/{item-id}/content?format={format}
/// &lt;/summary&gt;
public class MsGraphFileConversionService : IMsGraphFileConversionService
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly ILoggerAdapter&lt;MsGraphFileConversionService&gt; _logger;
    private readonly MsGraphSettings _msGraphSettings;
    private GraphServiceClient? _graphServiceClient;

    private HttpClient? _httpClient;

    public const int LargeFileThreshold = 3900000;

    public MsGraphFileConversionService(IHttpClientFactory httpClientFactory, MsGraphSettings msGraphSettings,
        ILoggerAdapter&lt;MsGraphFileConversionService&gt; logger)
    {
        _httpClientFactory = httpClientFactory;
        _msGraphSettings = msGraphSettings;
        _logger = logger;
    }

    public async Task&lt;string&gt; UploadFileAsync(string sourceFormat, Stream source)
    {
        if (source.Length &gt; LargeFileThreshold)
            return await UploadLargeFileAsync(sourceFormat, source);

        var httpClient = await CreateAuthorizedHttpClient();
        var tempFileName = $&quot;{Guid.NewGuid().ToString().Replace(&quot;-&quot;, &quot;&quot;)}.{sourceFormat}&quot;;
        var requestUrl = $&quot;{_msGraphSettings.GraphEndpoint}/root:/{tempFileName}:/content&quot;;
        var requestContent = new StreamContent(source);
        requestContent.Headers.ContentType = new MediaTypeHeaderValue(MimeTypeMap.GetMimeType(sourceFormat));
        var response = await httpClient.PutAsync(requestUrl, requestContent);
        if (!response.IsSuccessStatusCode)
            throw new MsGraphUploadFileException(response);
        var fileResponse = await response.Content.ReadFromJsonAsync&lt;UploadFileResponse&gt;();
        return fileResponse?.Id ?? throw new NullReferenceException(nameof(fileResponse.Id));
    }
    
    /// &lt;summary&gt;
    /// https://docs.microsoft.com/en-us/graph/api/driveitem-createuploadsession?view=graph-rest-1.0
    /// Since our max file upload size to ConversionController is 50 MB and graph lets uploading 60 MB in one put
    /// request we wont be chunking the upload into multiple parts
    /// &lt;/summary&gt;
    private async Task&lt;string&gt; UploadLargeFileAsync(string sourceFormat, Stream source)
    {
        var httpClient = await CreateAuthorizedHttpClient();
        var tempFileName = $&quot;{Guid.NewGuid().ToString().Replace(&quot;-&quot;, &quot;&quot;)}.{sourceFormat}&quot;;
        var createUploadSessionUrl = $&quot;{_msGraphSettings.GraphEndpoint}/root:/{tempFileName}:/createUploadSession&quot;;
        var createUploadSessionResponse = await httpClient.PostAsync(createUploadSessionUrl, null);
        if (!createUploadSessionResponse.IsSuccessStatusCode)
            throw new MsGraphUploadFileException(createUploadSessionResponse);
        var uploadSessionResponse =
            await createUploadSessionResponse.Content.ReadFromJsonAsync&lt;CreateUploadSessionResponse&gt;();
        var requestUrl = uploadSessionResponse?.UploadUrl ?? throw new NullReferenceException(uploadSessionResponse?.UploadUrl); // 
        var requestContent = new StreamContent(source); 
        requestContent.Headers.ContentType = new MediaTypeHeaderValue(MimeTypeMap.GetMimeType(sourceFormat));
        requestContent.Headers.ContentLength = source.Length;
        requestContent.Headers.ContentRange = new ContentRangeHeaderValue(0, source.Length-1, source.Length);
        var response = await httpClient.PutAsync(requestUrl, requestContent);
        if (!response.IsSuccessStatusCode)
            throw new MsGraphUploadFileException(response);
        var fileResponse = await response.Content.ReadFromJsonAsync&lt;UploadFileResponse&gt;();
        return fileResponse?.Id ?? throw new NullReferenceException(nameof(fileResponse.Id));
    }

    public async Task&lt;Stream&gt; GetFileInTargetFormatAsync(string fileId, string targetFormat)
    {
        var httpClient = await CreateAuthorizedHttpClient();

        var requestUrl = $&quot;{_msGraphSettings.GraphEndpoint}/{fileId}/content?format={targetFormat}&quot;;

        if (targetFormat.Equals(&quot;jpg&quot;))
            requestUrl += &quot;&amp;width=1920&amp;height=1080&quot;;

        var response = await httpClient.GetAsync(requestUrl);

        if (response.IsSuccessStatusCode) return await response.Content.ReadAsStreamAsync();

        try
        {
            await DeleteFileAsync(fileId);
        }
        catch (MsGraphDeleteFileException ex)
        {
            throw new MsGraphGetFileInTargetFormatException(response, ex);
        }

        throw new MsGraphGetFileInTargetFormatException(response);
    }

    public async Task DeleteFileAsync(string fileId)
    {
        var httpClient = await CreateAuthorizedHttpClient();
        var requestUrl = $&quot;{_msGraphSettings.GraphEndpoint}/{fileId}&quot;;
        var response = await httpClient.DeleteAsync(requestUrl);
        if (!response.IsSuccessStatusCode)
            throw new MsGraphDeleteFileException(response);
    }
    
    private async Task&lt;HttpClient&gt; CreateAuthorizedHttpClient()
    {
        if (_httpClient is not null) return _httpClient;

        var token = await GetAccessTokenAsync();
        _httpClient = _httpClientFactory.CreateClient(nameof(MsGraphFileConversionService));
        _httpClient.DefaultRequestHeaders.Add(&quot;Authorization&quot;, $&quot;Bearer {token}&quot;);

        return _httpClient;
    }

    private async Task&lt;string&gt; GetAccessTokenAsync()
    {
        var values = new List&lt;KeyValuePair&lt;string, string&gt;&gt;
        {
            new(&quot;client_id&quot;, _msGraphSettings.ClientId),
            new(&quot;client_secret&quot;, _msGraphSettings.ClientSecret),
            new(&quot;scope&quot;, _msGraphSettings.Scope),
            new(&quot;grant_type&quot;, &quot;client_credentials&quot;)
        };

        using var client = _httpClientFactory.CreateClient();

        var requestUrl = $&quot;{_msGraphSettings.AuthenticationEndpoint}/{_msGraphSettings.TenantId}/oauth2/v2.0/token&quot;;
        var requestContent = new FormUrlEncodedContent(values);

        var response = await client.PostAsync(requestUrl, requestContent);
        if (!response.IsSuccessStatusCode)
            throw new MsGraphAuthorizationException(response);
        var tokenResponse = await response.Content.ReadFromJsonAsync&lt;AuthenticationResponse&gt;();
        return tokenResponse?.AccessToken ?? throw new NullReferenceException(nameof(tokenResponse.AccessToken));
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[29,5,30,61,1],[31,5,31,6,1],[32,9,32,48,1],[33,9,33,44,1],[34,9,34,26,1],[35,5,35,6,1],[38,5,38,6,1],[39,9,39,48,1],[40,13,40,69,1],[42,9,42,61,1],[43,9,43,91,1],[44,9,44,92,1],[45,9,45,56,1],[46,9,46,110,1],[47,9,47,78,1],[48,9,48,43,1],[49,13,49,60,0],[50,9,50,91,1],[51,9,51,94,1],[52,5,52,6,1],[60,5,60,6,1],[61,9,61,61,1],[62,9,62,91,1],[63,9,63,116,1],[64,9,64,100,1],[65,9,65,62,1],[66,13,66,79,0],[67,9,68,104,1],[69,9,69,129,1],[70,9,70,56,1],[71,9,71,110,1],[72,9,72,62,1],[73,9,73,110,1],[74,9,74,78,1],[75,9,75,43,1],[76,13,76,60,0],[77,9,77,91,1],[78,9,78,94,1],[79,5,79,6,1],[82,5,82,6,1],[83,9,83,61,1],[85,9,85,101,1],[87,9,87,40,1],[88,13,88,53,1],[90,9,90,62,1],[92,9,92,42,1],[92,43,92,93,1],[95,9,95,10,0],[96,13,96,43,0],[97,9,97,10,0],[98,9,98,46,0],[99,9,99,10,0],[100,13,100,75,0],[103,9,103,67,0],[104,5,104,6,1],[107,5,107,6,1],[108,9,108,61,1],[109,9,109,71,1],[110,9,110,65,1],[111,9,111,43,1],[112,13,112,60,0],[113,5,113,6,1],[116,5,116,6,1],[117,9,117,37,1],[117,38,117,57,1],[119,9,119,49,1],[120,9,120,93,1],[121,9,121,83,1],[123,9,123,28,1],[124,5,124,6,1],[127,5,127,6,1],[128,9,134,11,1],[136,9,136,62,1],[138,9,138,117,1],[139,9,139,64,1],[141,9,141,75,1],[142,9,142,43,1],[143,13,143,63,0],[144,9,144,96,1],[145,9,145,114,1],[146,5,146,6,1]]);
    </script>
  </body>
</html>