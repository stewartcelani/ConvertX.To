<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\dev\ConvertX.To\src\Infrastructure\ConvertX.To.Infrastructure.Shared\Services\ConversionService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq.Expressions;
using ConvertX.To.Application.Domain.Entities;
using ConvertX.To.Application.Domain.Filters;
using ConvertX.To.Application.Interfaces;
using ConvertX.To.Application.Interfaces.Repositories;
using ConvertX.To.Application.Mappers;
using ConvertX.To.Application.Validators.Helpers;
using ConvertX.To.Domain;
using FluentValidation;

namespace ConvertX.To.Infrastructure.Shared.Services;

public class ConversionService : IConversionService
{
    private readonly IConversionRepository _conversionRepository;

    public ConversionService(IConversionRepository conversionRepository)
    {
        _conversionRepository = conversionRepository;
    }

    public async Task&lt;bool&gt; ExistsAsync(Guid id)
    {
        return await _conversionRepository.ExistsAsync(x =&gt; x.Id == id &amp;&amp; x.DateDeleted == null);
    }

    public async Task&lt;Conversion?&gt; GetByIdAsync(Guid id)
    {
        var conversionEntity = await _conversionRepository.GetAsync(id);
        return conversionEntity?.ToConversion();
    }

    public async Task&lt;IEnumerable&lt;Conversion&gt;&gt; GetAsync()
    {
        return await GetAsync(new ConversionFilter());
    }

    public async Task&lt;IEnumerable&lt;Conversion&gt;&gt; GetAsync(ConversionFilter conversionFilter)
    {
        var predicate = GetPredicateForConversionFilter(conversionFilter);

        var conversionEntities =
            await _conversionRepository.GetManyAsync(predicate, null,
                q =&gt; q.OrderByDescending(x =&gt; x.DateRequestCompleted));
        return conversionEntities.Select(x =&gt; x.ToConversion());
    }

    public async Task&lt;IEnumerable&lt;Conversion&gt;&gt; GetAsync(ConversionFilter conversionFilter,
        PaginationFilter paginationFilter)
    {
        var predicate = GetPredicateForConversionFilter(conversionFilter);

        var conversionEntities = await _conversionRepository.GetManyAsync(predicate, null,
            q =&gt; q.OrderByDescending(x =&gt; x.DateRequestCompleted), paginationFilter);
        return conversionEntities.Select(x =&gt; x.ToConversion());
    }


    public async Task&lt;bool&gt; CreateAsync(Conversion conversion)
    {
        if (await _conversionRepository.ExistsAsync(conversion.Id))
        {
            var message = $&quot;A conversion with id {conversion.Id} already exists&quot;;
            throw new ValidationException(message, ValidationFailureHelper.Generate(nameof(Conversion), message));
        }

        var conversionEntity = conversion.ToConversionEntity();
        var created = await _conversionRepository.CreateAsync(conversionEntity);
        return created;
    }

    public async Task&lt;bool&gt; UpdateAsync(Conversion conversion)
    {
        if (!await _conversionRepository.ExistsAsync(conversion.Id))
        {
            var message = $&quot;Can not update conversion with id {conversion.Id} as it does not exist&quot;;
            throw new ValidationException(message, ValidationFailureHelper.Generate(nameof(Conversion), message));
        }

        var conversionEntity = conversion.ToConversionEntity();
        var updated = await _conversionRepository.UpdateAsync(conversionEntity);
        return updated;
    }

    public async Task&lt;bool&gt; DeleteAsync(Guid conversionId)
    {
        if (!await _conversionRepository.ExistsAsync(conversionId)) return true;
        var deleted = await _conversionRepository.DeleteAsync(conversionId);
        return deleted;
    }

    public async Task&lt;bool&gt; ExpireConversions(DateTimeOffset timeToLive)
    {
        var conversions =
            (await _conversionRepository.GetManyAsync(x =&gt; (x.DateDeleted == null) &amp; (x.DateCreated &lt; timeToLive)))
            .ToList();
        var now = DateTimeOffset.Now;
        foreach (var conversion in conversions) conversion.DateDeleted = now;
        return await _conversionRepository.UpdateAsync(conversions);
    }

    public async Task&lt;bool&gt; IncrementDownloadCounter(Guid id)
    {
        var conversionEntity = await _conversionRepository.GetAsync(id);

        if (conversionEntity is null)
        {
            var message = $&quot;Can not increment download counter for conversion with id {id} as it does not exist&quot;;
            throw new ValidationException(message, ValidationFailureHelper.Generate(nameof(Conversion), message));
        }

        if (conversionEntity!.DateDeleted is not null)
        {
            var message =
                $&quot;Can not increment download counter for conversion with id {id} as it has been deleted from disk&quot;;
            throw new ValidationException(message, ValidationFailureHelper.Generate(nameof(Conversion), message));
        }

        conversionEntity.Downloads++;

        var updated = await _conversionRepository.UpdateAsync(conversionEntity);
        return updated;
    }

    public string GetConvertedFileName(string fileNameWithoutExtension, string targetFormat,
        string convertedFormat)
    {
        return targetFormat == convertedFormat
            ? $&quot;{fileNameWithoutExtension}.{targetFormat}&quot;
            : $&quot;{fileNameWithoutExtension}.{targetFormat}.{convertedFormat}&quot;;
    }

    private static Expression&lt;Func&lt;ConversionEntity, bool&gt;&gt; GetPredicateForConversionFilter(
        ConversionFilter conversionFilter)
    {
        Expression&lt;Func&lt;ConversionEntity, bool&gt;&gt;? predicate = x =&gt; x.DateDeleted == null;
        if (conversionFilter.Deleted) predicate = x =&gt; x.DateDeleted != null;
        return predicate;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,5,17,73,1],[18,5,18,6,1],[19,9,19,54,1],[20,5,20,6,1],[23,5,23,6,1],[24,9,24,98,1],[25,5,25,6,1],[28,5,28,6,1],[29,9,29,73,1],[30,9,30,49,1],[31,5,31,6,1],[34,5,34,6,1],[35,9,35,55,1],[36,5,36,6,1],[39,5,39,6,1],[40,9,40,75,1],[42,9,44,22,1],[44,22,44,70,1],[44,70,44,72,1],[45,9,45,47,1],[45,47,45,63,1],[45,63,45,65,1],[46,5,46,6,1],[50,5,50,6,1],[51,9,51,75,1],[53,9,54,18,1],[54,18,54,66,0],[54,66,54,86,1],[55,9,55,47,1],[55,47,55,63,1],[55,63,55,65,1],[56,5,56,6,1],[60,5,60,6,1],[61,9,61,68,1],[62,9,62,10,1],[63,13,63,82,1],[64,13,64,115,1],[67,9,67,64,1],[68,9,68,81,1],[69,9,69,24,1],[70,5,70,6,1],[73,5,73,6,1],[74,9,74,69,1],[75,9,75,10,1],[76,13,76,101,1],[77,13,77,115,1],[80,9,80,64,1],[81,9,81,81,1],[82,9,82,24,1],[83,5,83,6,1],[86,5,86,6,1],[87,9,87,68,1],[87,69,87,81,1],[88,9,88,77,1],[89,9,89,24,1],[90,5,90,6,1],[93,5,93,6,1],[94,9,96,23,1],[97,9,97,38,1],[98,9,98,16,1],[98,18,98,32,1],[98,33,98,35,1],[98,36,98,47,1],[98,49,98,78,1],[99,9,99,69,1],[100,5,100,6,1],[103,5,103,6,1],[104,9,104,73,1],[106,9,106,38,1],[107,9,107,10,1],[108,13,108,114,1],[109,13,109,115,1],[112,9,112,55,1],[113,9,113,10,1],[114,13,115,116,1],[116,13,116,115,1],[119,9,119,38,1],[121,9,121,81,1],[122,9,122,24,1],[123,5,123,6,1],[127,5,127,6,1],[128,9,130,78,1],[131,5,131,6,1],[135,5,135,6,1],[136,9,136,90,1],[137,9,137,38,1],[137,39,137,78,1],[138,9,138,26,1],[139,5,139,6,1]]);
    </script>
  </body>
</html>